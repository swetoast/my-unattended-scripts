#!/usr/bin/env bash
# Revision 8
# A Fan Controling script for my nvidia Card in a server
# Store this file at /usr/bin/fancontrol and then use the service to run it with systemd
# Dependacies: 
# gpustat https://github.com/wookayin/gpustat
# nvidia-settings, this must be installed in headless mode (see readme.md for more info)

# Configuration
CONFIG=/opt/etc/unattended_update.conf
if [ ! -f "$CONFIG" ]; then
    echo "No configuration file present at $CONFIG"
    exit 0
fi
source "$CONFIG"

# Debugging
[[ "$set_debug" == "enabled" ]] && set -x

# Functions
notify() {
    local message="Current Temp: $(gpustat | grep -oE '[0-9]{2}.C')"
    local title="Heat Warning on Nvidia Card"
    curl -u "$pushbullet_token": https://api.pushbullet.com/v2/pushes -d type=note -d title="$title" -d body="$message"
}

set_fan_speed() {
    local temp=$(gpustat | grep -oE '[0-9]{2}.C' | grep -oE '[0-9]{2}')
    local speed=22
    case $temp in
        3[0-9]) speed=25 ;;
        4[0-9]) speed=30 ;;
        5[0-9]) speed=50 ;;
        6[0-9]) speed=60 ;;
        7[0-9]) speed=80 ;;
        8[0-9]) speed=100; notify ;;
    esac
    DISPLAY=:0 XAUTHORITY=/var/run/lightdm/root/:0 /usr/bin/nvidia-settings -a "[fan:0]/GPUTargetFanSpeed=$speed"
}

store_last_value() {
    GPUTEMP=$(gpustat | grep -oE '[0-9]{2}.C' | grep -oE '[0-9]{2}')
    export GPUTEMP
}

initialize() {
    nvidia-xconfig --allow-empty-initial-configuration --enable-all-gpus --cool-bits=4 --separate-x-screens
    /usr/bin/nvidia-smi -pm ENABLED
    /usr/bin/nvidia-smi -pl 110
    X :0 &
    sleep 5
    export DISPLAY=:0
    DISPLAY=:0 XAUTHORITY=/var/run/lightdm/root/:0 /usr/bin/nvidia-settings -a "[gpu:0]/GPUFanControlState=1"
    store_last_value
}

control_fan_speed() {
    while true; do
        if [ "$(gpustat | grep -oE '[0-9]{2}.C' | grep -oE '[0-9]{2}')" -eq "$GPUTEMP" ]; then
            store_last_value
            sleep 60
        else
            set_fan_speed
            store_last_value
            echo "  Fan speed changed, temperature: $(gpustat | grep -oE '[0-9]{2}.C')"
            sleep 60
        fi
    done
}

# Main
case "${1}" in
    -init) initialize ;;
    *) control_fan_speed ;;
esac

[[ "$set_debug" == "enabled" ]] && set +x
